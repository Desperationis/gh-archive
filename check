#!/bin/bash

# check - Main script to sync all repos for a GitHub user/org
# Creates directory if needed, clones missing repos, updates existing ones

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [[ $# -lt 1 ]]; then
	echo "Usage: ./check [github username/org]"
	exit 1
fi

user="$1"

# Create directory if it doesn't exist (fixes the script order dependency bug)
if ! [[ -d "$SCRIPT_DIR/$user" ]]; then
	echo "Creating directory for $user..."
	mkdir -p "$SCRIPT_DIR/$user"
fi

# Use jq if available, otherwise fall back to grep (but with better regex)
if command -v jq &> /dev/null; then
	repos=$(gh repo list "$user" -L 999 --json name -q '.[].name')
else
	# Fallback: handle more characters in repo names (including +, @, etc.)
	repos=$(gh repo list "$user" -L 999 --json name | grep -oP '"name"\s*:\s*"\K[^"]+')
fi

if [[ -z "$repos" ]]; then
	echo "No repositories found for $user (or gh auth issue)."
	exit 1
fi

repocount=$(echo "$repos" | wc -l)
count=$("$SCRIPT_DIR/count" "$user" -c 2>/dev/null || echo "0")

echo "Found $repocount repositories on GitHub for $user."
echo "Currently have $count repositories locally."

if [[ "$repocount" -ne "$count" ]]; then
	echo ""
	echo "Missing repositories to sync:"

	missingRepos=()

	while IFS= read -r repo; do
		if ! [[ -d "$SCRIPT_DIR/$user/$repo" ]]; then
			echo "  * $repo"
			missingRepos+=("$repo")
		fi
	done <<< "$repos"

	if [[ ${#missingRepos[@]} -gt 0 ]]; then
		echo ""
		echo "Cloning ${#missingRepos[@]} missing repositories..."
		for repo in "${missingRepos[@]}"; do
			"$SCRIPT_DIR/clone" "$user" "$repo"
		done
	fi
else
	echo "All repositories are cloned!"
fi

echo ""
echo "Updating all repositories..."
"$SCRIPT_DIR/pull" "$user"

echo ""
echo "Sync complete for $user!"
